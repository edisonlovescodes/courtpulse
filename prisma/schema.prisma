generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id
  createdAt DateTime @default(now())
}

// Tracks which game a user unlocked in a time period
model GameUnlock {
  id          Int      @id @default(autoincrement())
  userId      String
  gameId      String
  sport       String   @default("nba") // 'nba' | 'nfl' | 'ucl'
  period      String   // 'day' | 'week'
  periodStart DateTime
  createdAt   DateTime @default(now())

  @@unique([userId, gameId, sport, period, periodStart])
  @@index([userId, period, periodStart])
}

// Usage tracking per game period (e.g., quarter)
model GameView {
  id        Int      @id @default(autoincrement())
  userId    String
  gameId    String
  sport     String   @default("nba") // 'nba' | 'nfl' | 'mlb'
  period    Int
  createdAt DateTime @default(now())

  @@unique([userId, gameId, sport, period])
  @@index([userId, gameId])
}

// Company notification settings (scoped per experience)
model NotificationSettings {
  id                   Int      @id @default(autoincrement())
  companyId            String
  experienceId         String   @default("default_experience") // Whop experience ID for multi-tenancy isolation
  sport                String   @default("nba") // 'nba' | 'nfl' | 'mlb'
  enabled              Boolean  @default(false)
  channelId            String?  // Whop chat channel ID
  channelName          String?  // Display name for UI
  updateFrequency      String   @default("every_point") // 'every_point' | 'every_minute' | 'every_quarter'
  notifyGameStart      Boolean  @default(true)
  notifyGameEnd        Boolean  @default(true)
  notifyQuarterEnd     Boolean  @default(true)
  trackedGames         String   @default("") // Comma-separated game IDs
  createGameChannels   Boolean  @default(false) // Enable automatic game channel embeds
  gameChannelId        String?  // Dedicated channel for game embeds
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@unique([companyId, experienceId, sport])
  @@index([companyId, experienceId])
}

// Track last notification state per game to avoid duplicates (scoped per experience)
model GameNotificationState {
  id                Int      @id @default(autoincrement())
  companyId         String
  experienceId      String   @default("default_experience") // Whop experience ID for multi-tenancy isolation
  gameId            String
  sport             String   @default("nba") // 'nba' | 'nfl' | 'mlb'
  lastHomeScore     Int      @default(0)
  lastAwayScore     Int      @default(0)
  lastPeriod        Int      @default(0)
  lastStatus        String   @default("")
  lastNotifiedAt    DateTime @default(now())

  @@unique([companyId, experienceId, gameId, sport])
  @@index([companyId, experienceId])
}

// Test game sessions for replaying historical games
model TestGameSession {
  id           Int      @id @default(autoincrement())
  gameId       String
  snapshotData String   @db.Text // JSON of historical game data
  startedAt    DateTime
  isActive     Boolean  @default(true)
  companyId    String
  createdAt    DateTime @default(now())

  @@unique([companyId, gameId])
  @@index([companyId, isActive])
}

model PlayerPropAlert {
  id           Int      @id @default(autoincrement())
  companyId    String
  experienceId String   @default("default_experience")
  gameId       String
  sport        String   @default("nba")
  playerId     Int      // NBA personId
  playerName   String
  propType     String   // 'points', 'assists', 'rebounds', 'threes'
  targetValue  Float
  condition    String   // 'over' | 'under'
  status       String   @default("pending") // 'pending', 'hit', 'completed'
  channelId    String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([companyId, experienceId, gameId])
}

// Track game channel embeds
model GameChannel {
  id           Int      @id @default(autoincrement())
  companyId    String
  experienceId String   @default("default_experience")
  gameId       String
  sport        String   @default("nba")
  channelId    String?  // Whop channel ID where embed was posted
  messageId    String?  // Message ID of the embed
  bannerUrl    String?  // Generated banner image URL
  homeTeam     String
  awayTeam     String
  homeRecord   String?
  awayRecord   String?
  gameStatus   String   @default("scheduled") // 'scheduled', 'live', 'final'
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@unique([companyId, experienceId, gameId, sport])
  @@index([companyId, experienceId])
  @@index([gameStatus])
}
